{% extends "base.html" %}

{% block content %}
<link rel="stylesheet" href="/static/css/styles.css">

<div class="container mt-5">
    <h2 class="mb-4" style="color: #0B1023; font-weight: 700;">üìä Entrega de Producci√≥n</h2>
    
    <div class="card mb-4">
        <div class="card-header">
            <h3 style="margin: 0;">Ingresa los datos de producci√≥n</h3>
        </div>
        <div class="card-body">
            <form action="/calcular-produccion" method="post" enctype="multipart/form-data">
                <div id="colores-container">
                    <div class="color-group mb-4" data-lote-id="1">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h4 style="margin: 0;">üì¶ Lote #1</h4>
                            <button type="button" class="btn btn-sm btn-danger" onclick="eliminarLote(1)" style="display: none;" id="btn-eliminar-1">üóëÔ∏è Eliminar</button>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="tipo_lote_1">Tipo de Lote:</label>
                                    <input type="text" id="tipo_lote_1" name="tipo_lote_1" class="form-control tipo-lote" placeholder="Ej: jogger, pantalon, blusa" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="color_1">Color:</label>
                                    <input type="text" id="color_1" name="color_1" class="form-control color-lote" placeholder="Ej: rojo, azul, blanco" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="precio_1">Precio Unitario ($):</label>
                                    <input type="number" id="precio_1" name="precio_1" class="form-control precio-lote" placeholder="Ej: 25000" step="0.01" min="0" required>
                                </div>
                            </div>
                        </div>
                        <div class="tallas-container mt-3">
                            <p style="color: #666; font-size: 0.9rem; margin-bottom: 1rem;"><strong>Ingresa la cantidad por talla:</strong></p>
                            <div class="table-responsive">
                                <table class="table table-bordered">
                                    <thead>
                                        <tr style="background-color: #f8f9fa;">
                                            <th style="color: #0B1023; font-weight: 600;">18-24</th>
                                            <th style="color: #0B1023; font-weight: 600;">24-36</th>
                                            <th style="color: #0B1023; font-weight: 600;">36-48</th>
                                            <th style="color: #0B1023; font-weight: 600;">2</th>
                                            <th style="color: #0B1023; font-weight: 600;">4</th>
                                            <th style="color: #0B1023; font-weight: 600;">6</th>
                                            <th style="color: #0B1023; font-weight: 600;">8</th>
                                            <th style="color: #0B1023; font-weight: 600;">10</th>
                                            <th style="color: #0B1023; font-weight: 600;">12</th>
                                            <th style="color: #0B1023; font-weight: 600;">14</th>
                                            <th style="color: #0B1023; font-weight: 600;">16</th>
                                            <th style="color: #0B1023; font-weight: 600;">18</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td><input type="number" name="talla_18_24_1" class="form-control" min="0" style="text-align: center;"></td>
                                            <td><input type="number" name="talla_24_36_1" class="form-control" min="0" style="text-align: center;"></td>
                                            <td><input type="number" name="talla_36_48_1" class="form-control" min="0" style="text-align: center;"></td>
                                            <td><input type="number" name="talla_2_1" class="form-control" min="0" style="text-align: center;"></td>
                                            <td><input type="number" name="talla_4_1" class="form-control" min="0" style="text-align: center;"></td>
                                            <td><input type="number" name="talla_6_1" class="form-control" min="0" style="text-align: center;"></td>
                                            <td><input type="number" name="talla_8_1" class="form-control" min="0" style="text-align: center;"></td>
                                            <td><input type="number" name="talla_10_1" class="form-control" min="0" style="text-align: center;"></td>
                                            <td><input type="number" name="talla_12_1" class="form-control" min="0" style="text-align: center;"></td>
                                            <td><input type="number" name="talla_14_1" class="form-control" min="0" style="text-align: center;"></td>
                                            <td><input type="number" name="talla_16_1" class="form-control" min="0" style="text-align: center;"></td>
                                            <td><input type="number" name="talla_18_1" class="form-control" min="0" style="text-align: center;"></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
            </div>
        </div>
    </div>
        
                <div style="margin-top: 2rem; display: flex; gap: 1rem; flex-wrap: wrap;">
                    <button type="button" class="btn btn-secondary" onclick="agregarColor()" style="flex: 1; min-width: 200px;">‚ûï Agregar Otro Lote</button>
                    <button type="submit" class="btn btn-primary" style="flex: 1; min-width: 200px;">üßÆ Calcular Producci√≥n</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
let colorCount = 1;
let lotesGuardados = {};

// Funci√≥n para guardar datos del lote actual cuando cambia
function guardarDatosLote(loteId) {
    const tipoLote = document.getElementById(`tipo_lote_${loteId}`)?.value || '';
    const colorLote = document.getElementById(`color_${loteId}`)?.value || '';
    const precioLote = document.getElementById(`precio_${loteId}`)?.value || '';
    
    if (tipoLote && colorLote && precioLote) {
        lotesGuardados[loteId] = {
            tipo: tipoLote,
            color: colorLote,
            precio: precioLote
        };
    }
}

// Actualizar campos listeners para guardar datos
document.addEventListener('change', function(e) {
    if (e.target.classList.contains('tipo-lote') || e.target.classList.contains('color-lote') || e.target.classList.contains('precio-lote')) {
        const inputId = e.target.id;
        const loteId = inputId.split('_').pop();
        guardarDatosLote(loteId);
        actualizarSelectoresLotes();
    }
});

function actualizarSelectoresLotes() {
    const selectores = document.querySelectorAll('.selector-lote-existente');
    selectores.forEach(selector => {
        const loteIdActual = selector.closest('.color-group').getAttribute('data-lote-id');
        const seleccionActual = selector.value;
        
        selector.innerHTML = '<option value="">-- Seleccionar lote existente --</option>';
        
        for (const [loteId, datos] of Object.entries(lotesGuardados)) {
            if (loteId !== loteIdActual) {
                const option = document.createElement('option');
                option.value = loteId;
                option.textContent = `${datos.tipo} - ${datos.color} ($${datos.precio})`;
                selector.appendChild(option);
            }
        }
        
        selector.value = seleccionActual;
    });
}

function aplicarLoteExistente(loteId) {
    const selector = document.querySelector(`[data-lote-id="${loteId}"] .selector-lote-existente`);
    const loteSeleccionado = selector.value;
    
    if (loteSeleccionado && lotesGuardados[loteSeleccionado]) {
        const datos = lotesGuardados[loteSeleccionado];
        document.getElementById(`tipo_lote_${loteId}`).value = datos.tipo;
        document.getElementById(`color_${loteId}`).value = datos.color;
        document.getElementById(`precio_${loteId}`).value = datos.precio;
    }
}

function agregarColor() {
    colorCount++;
    guardarDatosLote(colorCount - 1);
    
    const container = document.getElementById('colores-container');
    const nuevoColor = `
        <div class="color-group mb-4" data-lote-id="${colorCount}">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h4 style="margin: 0;">üì¶ Lote #${colorCount}</h4>
                <button type="button" class="btn btn-sm btn-danger" onclick="eliminarLote(${colorCount})">üóëÔ∏è Eliminar</button>
            </div>
            
            <div style="background-color: #f0f4ff; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
                <p style="margin: 0 0 0.5rem 0; color: #0B1023; font-weight: 600;">üìã O selecciona un lote ya creado:</p>
                <div class="row">
                    <div class="col-md-8">
                        <select class="form-control selector-lote-existente" onchange="aplicarLoteExistente(${colorCount})">
                            <option value="">-- Seleccionar lote existente --</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-4">
                    <div class="form-group">
                        <label for="tipo_lote_${colorCount}">Tipo de Lote:</label>
                        <input type="text" id="tipo_lote_${colorCount}" name="tipo_lote_${colorCount}" class="form-control tipo-lote" placeholder="Ej: jogger, pantalon, blusa" required>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label for="color_${colorCount}">Color:</label>
                        <input type="text" id="color_${colorCount}" name="color_${colorCount}" class="form-control color-lote" placeholder="Ej: rojo, azul, blanco" required>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label for="precio_${colorCount}">Precio Unitario ($):</label>
                        <input type="number" id="precio_${colorCount}" name="precio_${colorCount}" class="form-control precio-lote" placeholder="Ej: 25000" step="0.01" min="0" required>
                    </div>
                </div>
            </div>
            <div class="tallas-container mt-3">
                <p style="color: #666; font-size: 0.9rem; margin-bottom: 1rem;"><strong>Ingresa la cantidad por talla:</strong></p>
                <div class="table-responsive">
                    <table class="table table-bordered">
                        <thead>
                            <tr style="background-color: #f8f9fa;">
                                <th style="color: #0B1023; font-weight: 600;">18-24</th>
                                <th style="color: #0B1023; font-weight: 600;">24-36</th>
                                <th style="color: #0B1023; font-weight: 600;">36-48</th>
                                <th style="color: #0B1023; font-weight: 600;">2</th>
                                <th style="color: #0B1023; font-weight: 600;">4</th>
                                <th style="color: #0B1023; font-weight: 600;">6</th>
                                <th style="color: #0B1023; font-weight: 600;">8</th>
                                <th style="color: #0B1023; font-weight: 600;">10</th>
                                <th style="color: #0B1023; font-weight: 600;">12</th>
                                <th style="color: #0B1023; font-weight: 600;">14</th>
                                <th style="color: #0B1023; font-weight: 600;">16</th>
                                <th style="color: #0B1023; font-weight: 600;">18</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><input type="number" name="talla_18_24_${colorCount}" class="form-control" min="0"  style="text-align: center;"></td>
                                <td><input type="number" name="talla_24_36_${colorCount}" class="form-control" min="0"  style="text-align: center;"></td>
                                <td><input type="number" name="talla_36_48_${colorCount}" class="form-control" min="0"  style="text-align: center;"></td>
                                <td><input type="number" name="talla_2_${colorCount}" class="form-control" min="0"  style="text-align: center;"></td>
                                <td><input type="number" name="talla_4_${colorCount}" class="form-control" min="0"  style="text-align: center;"></td>
                                <td><input type="number" name="talla_6_${colorCount}" class="form-control" min="0"  style="text-align: center;"></td>
                                <td><input type="number" name="talla_8_${colorCount}" class="form-control" min="0"  style="text-align: center;"></td>
                                <td><input type="number" name="talla_10_${colorCount}" class="form-control" min="0"  style="text-align: center;"></td>
                                <td><input type="number" name="talla_12_${colorCount}" class="form-control" min="0"  style="text-align: center;"></td>
                                <td><input type="number" name="talla_14_${colorCount}" class="form-control" min="0"  style="text-align: center;"></td>
                                <td><input type="number" name="talla_16_${colorCount}" class="form-control" min="0"  style="text-align: center;"></td>
                                <td><input type="number" name="talla_18_${colorCount}" class="form-control" min="0"  style="text-align: center;"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
    container.insertAdjacentHTML('beforeend', nuevoColor);
    actualizarSelectoresLotes();
}

function eliminarLote(loteId) {
    const loteElement = document.querySelector(`[data-lote-id="${loteId}"]`);
    if (loteElement) {
        loteElement.remove();
        delete lotesGuardados[loteId];
        actualizarSelectoresLotes();
    }
}

// Mostrar bot√≥n eliminar cuando haya m√°s de un lote
function actualizarBotoneEliminar() {
    const lotes = document.querySelectorAll('.color-group');
    lotes.forEach(lote => {
        const btnEliminar = lote.querySelector('.btn-danger');
        if (btnEliminar) {
            btnEliminar.style.display = lotes.length > 1 ? 'inline-block' : 'none';
        }
    });
}

// Inicializar
actualizarBotoneEliminar();
guardarDatosLote(1);
</script>
{% endblock %}