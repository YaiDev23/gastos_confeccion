{% extends "base.html" %}

{% block content %}
<link rel="stylesheet" href="/static/css/styles.css">

<style>
    .header-nav {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 3px solid #0B1023;
    }
    
    .header-nav h2 {
        margin: 0;
        color: #0B1023;
        font-size: 28px;
        font-weight: 700;
    }
    
    .btn-nav {
        display: inline-block;
        padding: 10px 20px;
        margin-left: 10px;
        text-decoration: none;
        border-radius: 8px;
        font-weight: bold;
        transition: all 0.3s;
        color: white;
        font-size: 14px;
    }
    
    .btn-menu {
        background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
    }
    
    .btn-menu:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
    }
    
    .btn-view {
        background: linear-gradient(135deg, #0B1023 0%, #000000 100%);
    }
    
    .btn-view:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 25px rgba(11, 16, 35, 0.3);
    }

    .delivery-card {
        background: #f8f9fa;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        position: relative;
        transition: all 0.3s ease;
    }

    .delivery-card:hover {
        border-color: #0B1023;
        box-shadow: 0 4px 12px rgba(11, 16, 35, 0.1);
    }

    .delivery-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        padding-bottom: 0.75rem;
        border-bottom: 2px solid #dee2e6;
    }

    .delivery-card-header h5 {
        margin: 0;
        color: #0B1023;
        font-weight: 600;
    }

    .btn-remove-delivery {
        background: #dc3545;
        color: white;
        border: none;
        padding: 5px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: all 0.2s;
    }

    .btn-remove-delivery:hover {
        background: #c82333;
        transform: scale(1.05);
    }

    .table-sizes-responsive {
        overflow-x: auto;
        border-radius: 8px;
        border: 1px solid #dee2e6;
    }

    .table-sizes-responsive table {
        margin-bottom: 0;
    }

    .table-sizes-responsive thead {
        background-color: #f8f9fa;
    }

    .table-sizes-responsive th {
        color: #0B1023;
        font-weight: 600;
        padding: 0.75rem !important;
        text-align: center;
        border-color: #dee2e6;
        font-size: 0.9rem;
        white-space: nowrap;
    }

    .table-sizes-responsive td {
        padding: 0.5rem !important;
        border-color: #dee2e6;
    }

    .table-sizes-responsive td input {
        text-align: center;
        font-weight: 500;
    }

    .table-sizes-responsive td textarea {
        font-size: 0.85rem;
    }

    .size-group-header {
        background-color: #e9ecef !important;
        font-weight: 700 !important;
        color: #0B1023 !important;
    }
</style>

<div class="header-nav">
    <h2>üì¶ Registrar Entrega de Cortes</h2>
    <div>
        <a href="/menu_entrega" class="btn-nav btn-menu">‚Üê Men√∫ de Entregas</a>
    </div>
</div>

<div class="container mt-5">
    
    <div class="card mb-4">
        <div class="card-header">
            <h3 style="margin: 0;">Ingresa los datos de la entrega</h3>
        </div>
        <div class="card-body">
            <form id="deliveryForm">
                <!-- Informaci√≥n General -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="factorySelect" style="color: #0B1023; font-weight: 600;">üë§ Responsable (Taller):</label>
                            <div class="position-relative">
                                <input 
                                    type="text" 
                                    id="factorySelect" 
                                    class="form-control" 
                                    placeholder="üîç Buscar taller..." 
                                    autocomplete="off"
                                    required
                                    style="padding-right: 40px;">
                                <div id="factoriesDropdown" class="position-absolute w-100" style="display: none; top: 100%; left: 0; border: 1px solid #ddd; background: white; border-radius: 4px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); max-height: 300px; overflow-y: auto; z-index: 1000;">
                                    <!-- Se llenar√° din√°micamente con JavaScript -->
                                </div>
                            </div>
                            <input type="hidden" id="owner" name="owner" required>
                            <small id="ownerHelper" style="display: none; color: #dc3545; font-size: 0.85rem; margin-top: 0.25rem;">‚ùå Por favor selecciona un taller v√°lido</small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="date">Fecha:</label>
                            <input type="date" id="date" name="date" class="form-control" required>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="lot">Lote (Opcional):</label>
                            <input type="text" id="lot" name="lot" class="form-control" placeholder="Ej: LOTE-001">
                        </div>
                    </div>
                </div>

              

                <!-- Tabla de Tallas -->
                <div class="mt-4 mb-4">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <div>
                            <h4 style="color: #0B1023; font-weight: 600; margin: 0;">üìè Cantidades por Talla</h4>
                            <p style="color: #666; font-size: 0.9rem; margin: 0.5rem 0 0 0;"><strong>Ingresa la cantidad de piezas para cada talla:</strong></p>
                        </div>
                    </div>
                    
                    <div id="deliveriesContainer" class="deliveries-container">
                        <!-- Las entregas se agregar√°n aqu√≠ din√°micamente -->
                    </div>
                    
                    <!-- Bot√≥n para a√±adir m√°s entregas -->
                    <div style="margin-top: 1.5rem; text-align: center;">
                        <button type="button" id="addDeliveryBtn" class="btn btn-outline-primary" style="padding: 10px 30px; font-size: 1.1rem; border-width: 2px;">
                            <strong>+ A√±adir otra entrega</strong>
                        </button>
                    </div>
                </div>

                <!-- Botones -->
                <div style="margin-top: 2rem; display: flex; gap: 1rem; flex-wrap: wrap;">
                    <button type="reset" class="btn btn-secondary" style="flex: 1; min-width: 200px;">üîÑ Limpiar Formulario</button>
                    <button type="submit" class="btn btn-primary" style="flex: 1; min-width: 200px;">üíæ Guardar Entrega</button>
                </div>
            </form>

            <!-- Mensaje de estado -->
            <div id="statusMessage" style="margin-top: 1rem; display: none;">
                <div id="alertBox" class="alert" role="alert"></div>
            </div>
        </div>
    </div>
</div>

<script>
// Variable global para almacenar los talleres
let factories = [];

// Cargar talleres desde la API
async function loadFactories() {
    try {
        const response = await fetch('/api/factories');
        if (response.ok) {
            factories = await response.json();
        } else {
            console.error('Error al cargar talleres:', response.statusText);
        }
    } catch (error) {
        console.error('Error al conectar con la API:', error);
    }
}

// Mostrar dropdown con talleres
function showFactoriesDropdown(searchTerm = '') {
    const dropdown = document.getElementById('factoriesDropdown');
    const filtered = factories.filter(f => 
        f.owner.toLowerCase().includes(searchTerm.toLowerCase())
    );
    
    if (filtered.length === 0) {
        dropdown.innerHTML = '<div style="padding: 15px; text-align: center; color: #999;">No se encontraron talleres</div>';
    } else {
        dropdown.innerHTML = filtered.map(factory => `
            <div class="factory-option" data-factory-id="${factory.id_factory}" data-factory-name="${factory.owner}" 
                 style="padding: 12px 15px; border-bottom: 1px solid #f0f0f0; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 10px;">
                <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #0B1023 0%, #000000 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #0B1023; font-weight: bold; flex-shrink: 0;">
                    ${factory.owner.charAt(0).toUpperCase()}
                </div>
                <div style="flex: 1;">
                    <div style="font-weight: 600; color: #333;">${factory.owner}</div>
                    <div style="font-size: 0.85rem; color: #999;">ID: ${factory.id_factory}</div>
                </div>
                <div style="color: #0B1023; font-size: 1.2rem;">‚úì</div>
            </div>
        `).join('');
    }
    
    dropdown.style.display = 'block';
    
    // Agregar listeners a las opciones
    document.querySelectorAll('.factory-option').forEach(option => {
        option.addEventListener('click', function() {
            const factoryName = this.dataset.factoryName;
            const factoryId = this.dataset.factoryId;
            
            document.getElementById('factorySelect').value = factoryName;
            document.getElementById('owner').value = factoryName;
            dropdown.style.display = 'none';
            document.getElementById('ownerHelper').style.display = 'none';
            document.getElementById('factorySelect').classList.remove('is-invalid');
        });
        
        option.addEventListener('mouseover', function() {
            this.style.backgroundColor = '#f8f9ff';
        });
        
        option.addEventListener('mouseout', function() {
            this.style.backgroundColor = 'transparent';
        });
    });
}

// Event listeners para el campo de b√∫squeda
document.getElementById('factorySelect').addEventListener('input', function(e) {
    const searchTerm = this.value;
    if (searchTerm.length > 0) {
        showFactoriesDropdown(searchTerm);
    } else {
        document.getElementById('factoriesDropdown').style.display = 'none';
    }
});

document.getElementById('factorySelect').addEventListener('focus', function() {
    if (this.value.length > 0 || factories.length > 0) {
        showFactoriesDropdown(this.value);
    }
});

// Cerrar dropdown al hacer click fuera
document.addEventListener('click', function(e) {
    const dropdown = document.getElementById('factoriesDropdown');
    const factorySelect = document.getElementById('factorySelect');
    
    if (!e.target.closest('.form-group')) {
        dropdown.style.display = 'none';
    }
});

// Contador de entregas y group_id
let deliveryCount = 0;
let currentGroupId = null;

// Generar un ID √∫nico para agrupar entregas
function generateGroupId() {
    return 'grp_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
}

// Crear HTML para una fila de entrega
function createDeliveryCardHTML(index) {
    return `
    <div class="delivery-card" data-delivery-index="${index}">
        <div class="delivery-card-header">
            <h5>üì¶ Entrega #${index + 1}</h5>
            ${index > 0 ? `<button type="button" class="btn-remove-delivery" onclick="removeDelivery(${index})">‚ùå Eliminar</button>` : ''}
        </div>
        
        <div style="margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid #dee2e6;">
            <div class="form-group">
                <label for="delivery_${index}_type" style="color: #0B1023; font-weight: 600;">Tipo de Producto:</label>
                <input type="text" id="delivery_${index}_type" name="delivery_${index}_type" class="form-control" placeholder="Ej: Jogger, Pantal√≥n, Blusa" value="">
            </div>
        </div>
        
        <div class="table-sizes-responsive">
            <table class="table table-bordered table-sm" style="margin-bottom: 0;">
                <thead>
                    <tr style="background-color: #f8f9fa;">
                        <th>Color</th>
                        <th>RIB</th>
                        <th>Tipo de Tela</th>
                        <th colspan="5" style="text-align: center; background-color: #e9ecef;">üë∂ Beb√© (meses)</th>
                        <th colspan="9" style="text-align: center; background-color: #e9ecef;">üëß Ni√±@s (tallas)</th>
                        <th>Observaciones</th>
                    </tr>
                    <tr style="background-color: #f8f9fa;">
                        <th>-</th>
                        <th>-</th>
                        <th>-</th>
                        <th style="font-size: 0.85rem;">6-12</th>
                        <th style="font-size: 0.85rem;">12-18</th>
                        <th style="font-size: 0.85rem;">18-24</th>
                        <th style="font-size: 0.85rem;">24-36</th>
                        <th style="font-size: 0.85rem;">36-48</th>
                        <th style="font-size: 0.85rem;">2</th>
                        <th style="font-size: 0.85rem;">4</th>
                        <th style="font-size: 0.85rem;">6</th>
                        <th style="font-size: 0.85rem;">8</th>
                        <th style="font-size: 0.85rem;">10</th>
                        <th style="font-size: 0.85rem;">12</th>
                        <th style="font-size: 0.85rem;">14</th>
                        <th style="font-size: 0.85rem;">16</th>
                        <th style="font-size: 0.85rem;">18</th>
                        <th>-</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><input type="text" name="delivery_${index}_color" class="form-control form-control-sm" placeholder="Rojo, Azul..."></td>
                        <td><input type="text" name="delivery_${index}_rib" class="form-control form-control-sm" placeholder="RIB"></td>
                        <td><input type="text" name="delivery_${index}_type_fabric" class="form-control form-control-sm" placeholder="Algod√≥n..."></td>
                        <td><input type="number" name="delivery_${index}_sz6_12" class="form-control form-control-sm" min="0" value="0" style="text-align: center;"></td>
                        <td><input type="number" name="delivery_${index}_sz12_18" class="form-control form-control-sm" min="0" value="0" style="text-align: center;"></td>
                        <td><input type="number" name="delivery_${index}_sz18_24" class="form-control form-control-sm" min="0" value="0" style="text-align: center;"></td>
                        <td><input type="number" name="delivery_${index}_sz24_36" class="form-control form-control-sm" min="0" value="0" style="text-align: center;"></td>
                        <td><input type="number" name="delivery_${index}_sz36_48" class="form-control form-control-sm" min="0" value="0" style="text-align: center;"></td>
                        <td><input type="number" name="delivery_${index}_sz2" class="form-control form-control-sm" min="0" value="0" style="text-align: center;"></td>
                        <td><input type="number" name="delivery_${index}_sz4" class="form-control form-control-sm" min="0" value="0" style="text-align: center;"></td>
                        <td><input type="number" name="delivery_${index}_sz6" class="form-control form-control-sm" min="0" value="0" style="text-align: center;"></td>
                        <td><input type="number" name="delivery_${index}_sz8" class="form-control form-control-sm" min="0" value="0" style="text-align: center;"></td>
                        <td><input type="number" name="delivery_${index}_sz10" class="form-control form-control-sm" min="0" value="0" style="text-align: center;"></td>
                        <td><input type="number" name="delivery_${index}_sz12" class="form-control form-control-sm" min="0" value="0" style="text-align: center;"></td>
                        <td><input type="number" name="delivery_${index}_sz14" class="form-control form-control-sm" min="0" value="0" style="text-align: center;"></td>
                        <td><input type="number" name="delivery_${index}_sz16" class="form-control form-control-sm" min="0" value="0" style="text-align: center;"></td>
                        <td><input type="number" name="delivery_${index}_sz18" class="form-control form-control-sm" min="0" value="0" style="text-align: center;"></td>
                        <td><textarea name="delivery_${index}_annotation" class="form-control form-control-sm" placeholder="Notas..." rows="2" style="resize: vertical;"></textarea></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    `;
}

// Agregar una nueva entrega
function addDelivery() {
    const container = document.getElementById('deliveriesContainer');
    container.insertAdjacentHTML('beforeend', createDeliveryCardHTML(deliveryCount));
    deliveryCount++;
}

// Eliminar una entrega
function removeDelivery(index) {
    const card = document.querySelector(`[data-delivery-index="${index}"]`);
    if (card) {
        card.remove();
    }
}

// Event listener para el bot√≥n de a√±adir entrega
document.getElementById('addDeliveryBtn').addEventListener('click', function() {
    addDelivery();
});

document.getElementById('deliveryForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    // Generar un nuevo group_id para este env√≠o
    currentGroupId = generateGroupId();

    // Validar que el owner sea un taller v√°lido
    const ownerValue = document.getElementById('owner').value;
    const isValidFactory = factories.some(f => f.owner === ownerValue);
    
    if (!isValidFactory) {
        const alertBox = document.getElementById('alertBox');
        alertBox.className = 'alert alert-danger';
        alertBox.innerHTML = '<strong>‚ùå Error!</strong> Por favor selecciona un taller v√°lido de la lista';
        document.getElementById('statusMessage').style.display = 'block';
        document.getElementById('factorySelect').classList.add('is-invalid');
        document.getElementById('ownerHelper').style.display = 'block';
        return;
    }

    // Obtener todas las entregas
    const deliveryCards = document.querySelectorAll('.delivery-card');
    
    if (deliveryCards.length === 0) {
        const alertBox = document.getElementById('alertBox');
        alertBox.className = 'alert alert-warning';
        alertBox.innerHTML = '<strong>‚ö†Ô∏è Atenci√≥n!</strong> Por favor agrega al menos una entrega';
        document.getElementById('statusMessage').style.display = 'block';
        return;
    }

    let successCount = 0;
    let errorMessages = [];

    // Procesar cada entrega
    for (let card of deliveryCards) {
        const index = card.dataset.deliveryIndex;
        
        const formData = {
            owner: ownerValue,
            date: document.getElementById('date').value,
            lot: document.getElementById('lot').value || null,
            type: document.querySelector(`input[name="delivery_${index}_type"]`).value || null,
            color: document.querySelector(`input[name="delivery_${index}_color"]`).value || null,
            type_fabric: document.querySelector(`input[name="delivery_${index}_type_fabric"]`).value || null,
            rib: document.querySelector(`input[name="delivery_${index}_rib"]`).value || null,
            annotation: document.querySelector(`textarea[name="delivery_${index}_annotation"]`).value || null,
            sz6_12: parseInt(document.querySelector(`input[name="delivery_${index}_sz6_12"]`).value) || 0,
            sz12_18: parseInt(document.querySelector(`input[name="delivery_${index}_sz12_18"]`).value) || 0,
            sz18_24: parseInt(document.querySelector(`input[name="delivery_${index}_sz18_24"]`).value) || 0,
            sz24_36: parseInt(document.querySelector(`input[name="delivery_${index}_sz24_36"]`).value) || 0,
            sz36_48: parseInt(document.querySelector(`input[name="delivery_${index}_sz36_48"]`).value) || 0,
            sz2: parseInt(document.querySelector(`input[name="delivery_${index}_sz2"]`).value) || 0,
            sz4: parseInt(document.querySelector(`input[name="delivery_${index}_sz4"]`).value) || 0,
            sz6: parseInt(document.querySelector(`input[name="delivery_${index}_sz6"]`).value) || 0,
            sz8: parseInt(document.querySelector(`input[name="delivery_${index}_sz8"]`).value) || 0,
            sz10: parseInt(document.querySelector(`input[name="delivery_${index}_sz10"]`).value) || 0,
            sz12: parseInt(document.querySelector(`input[name="delivery_${index}_sz12"]`).value) || 0,
            sz14: parseInt(document.querySelector(`input[name="delivery_${index}_sz14"]`).value) || 0,
            sz16: parseInt(document.querySelector(`input[name="delivery_${index}_sz16"]`).value) || 0,
            sz18: parseInt(document.querySelector(`input[name="delivery_${index}_sz18"]`).value) || 0,
            id_group: currentGroupId
        };

        try {
            const response = await fetch('/api/deliveries', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            });

            if (response.ok) {
                const result = await response.json();
                successCount++;
            } else {
                try {
                    const error = await response.json();
                    // Manejo espec√≠fico para error 422 (validaci√≥n)
                    if (response.status === 422 && error.detail && Array.isArray(error.detail)) {
                        const validationErrors = error.detail.map(e => `${e.loc[e.loc.length - 1]}: ${e.msg}`).join('; ');
                        errorMessages.push(`Entrega #${parseInt(index) + 1}: ${validationErrors}`);
                    } else {
                        errorMessages.push(`Entrega #${parseInt(index) + 1}: ${error.detail || 'Error en la solicitud'}`);
                    }
                } catch (parseError) {
                    errorMessages.push(`Entrega #${parseInt(index) + 1}: Error ${response.status} - ${response.statusText}`);
                }
            }
        } catch (error) {
            errorMessages.push(`Entrega #${parseInt(index) + 1}: ${error.message}`);
        }
    }

    // Mostrar resultado
    const statusMessage = document.getElementById('statusMessage');
    const alertBox = document.getElementById('alertBox');

    if (successCount === deliveryCards.length && errorMessages.length === 0) {
        alertBox.className = 'alert alert-success';
        alertBox.innerHTML = `<strong>‚úÖ √âxito!</strong> ${successCount} entrega${successCount > 1 ? 's' : ''} registrada${successCount > 1 ? 's' : ''} correctamente (Grupo: ${currentGroupId})`;
        document.getElementById('deliveryForm').reset();
        document.getElementById('owner').value = '';
        document.getElementById('factorySelect').value = '';
        document.getElementById('deliveriesContainer').innerHTML = '';
        deliveryCount = 0;
        currentGroupId = null;
        addDelivery(); // Agregar una entrega por defecto
        
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('date').value = today;
    } else if (successCount > 0) {
        alertBox.className = 'alert alert-warning';
        alertBox.innerHTML = `<strong>‚ö†Ô∏è Parcial!</strong> ${successCount} de ${deliveryCards.length} entrega(s) registrada(s).<br>${errorMessages.join('<br>')}`;
    } else {
        alertBox.className = 'alert alert-danger';
        alertBox.innerHTML = `<strong>‚ùå Error!</strong> No se registraron entregas.<br>${errorMessages.join('<br>')}`;
    }
    
    statusMessage.style.display = 'block';
});

// Establecer la fecha de hoy por defecto y cargar talleres al cargar
document.addEventListener('DOMContentLoaded', function() {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('date').value = today;
    loadFactories();
    
    // Agregar la primera entrega por defecto
    addDelivery();
});
</script>
{% endblock %}