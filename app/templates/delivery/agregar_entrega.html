{% extends "base.html" %}

{% block content %}
<link rel="stylesheet" href="/static/css/styles.css">

<style>
    .header-nav {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 3px solid #0B1023;
    }
    
    .header-nav h2 {
        margin: 0;
        color: #0B1023;
        font-size: 28px;
        font-weight: 700;
    }
    
    .btn-nav {
        display: inline-block;
        padding: 10px 20px;
        margin-left: 10px;
        text-decoration: none;
        border-radius: 8px;
        font-weight: bold;
        transition: all 0.3s;
        color: white;
        font-size: 14px;
    }
    
    .btn-menu {
        background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
    }
    
    .btn-menu:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
    }
    
    .btn-view {
        background: linear-gradient(135deg, #0B1023 0%, #000000 100%);
    }
    
    .btn-view:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 25px rgba(11, 16, 35, 0.3);
    }
</style>

<div class="header-nav">
    <h2>üì¶ Registrar Entrega de Cortes</h2>
    <div>
        <a href="/menu_entrega" class="btn-nav btn-menu">‚Üê Men√∫ de Entregas</a>
    </div>
</div>

<div class="container mt-5">
    
    <div class="card mb-4">
        <div class="card-header">
            <h3 style="margin: 0;">Ingresa los datos de la entrega</h3>
        </div>
        <div class="card-body">
            <form id="deliveryForm">
                <!-- Informaci√≥n General -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="factorySelect" style="color: #0B1023; font-weight: 600;">üë§ Responsable (Taller):</label>
                            <div class="position-relative">
                                <input 
                                    type="text" 
                                    id="factorySelect" 
                                    class="form-control" 
                                    placeholder="üîç Buscar taller..." 
                                    autocomplete="off"
                                    required
                                    style="padding-right: 40px;">
                                <div id="factoriesDropdown" class="position-absolute w-100" style="display: none; top: 100%; left: 0; border: 1px solid #ddd; background: white; border-radius: 4px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); max-height: 300px; overflow-y: auto; z-index: 1000;">
                                    <!-- Se llenar√° din√°micamente con JavaScript -->
                                </div>
                            </div>
                            <input type="hidden" id="owner" name="owner" required>
                            <small id="ownerHelper" style="display: none; color: #dc3545; font-size: 0.85rem; margin-top: 0.25rem;">‚ùå Por favor selecciona un taller v√°lido</small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="date">Fecha:</label>
                            <input type="date" id="date" name="date" class="form-control" required>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="lot">Lote (Opcional):</label>
                            <input type="text" id="lot" name="lot" class="form-control" placeholder="Ej: LOTE-001">
                        </div>
                    </div>
                </div>

                <div class="row mb-4">
                    
                    
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="annotation">Observacion (Opcional):</label>
                        </div>
                    </div>
                </div>

                <!-- Tabla de Tallas -->
                <div class="mt-4 mb-4">
                    <h4 style="color: #0B1023; font-weight: 600; margin-bottom: 1rem;">üìè Cantidades por Talla</h4>
                    <p style="color: #666; font-size: 0.9rem; margin-bottom: 1rem;"><strong>Ingresa la cantidad de piezas para cada talla:</strong></p>
                        <div class="table-responsive">
                            <table class="table table-bordered">
                                <thead>
                                    <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="type">Tipo de Producto:</label>
                                        <input type="text" id="type" name="type" class="form-control" placeholder="Ej: Jogger, Pantal√≥n, Blusa">
                                    </div>
                        </div>
   
                                </tr>
                                <tr style="background-color: #f8f9fa;">
                                    <th colspan="9" style="color: #0B1023; font-weight: 600; text-align: center;">Tallas</th>
                                </tr>
                                <tr style="background-color: #f8f9fa;">
                                    <th style="color: #0B1023; font-weight: 600;">color</th>
                                    <th style="color: #0B1023; font-weight: 600;">RIB</th>
                                    <th style="color: #0B1023; font-weight: 600;">tipo tela</th>
                                    <th style="color: #0B1023; font-weight: 600;">6-12</th>
                                    <th style="color: #0B1023; font-weight: 600;">12-18</th>
                                    <th style="color: #0B1023; font-weight: 600;">18-24</th>
                                    <th style="color: #0B1023; font-weight: 600;">24-36</th>
                                    <th style="color: #0B1023; font-weight: 600;">36-48</th>
                                    <th style="color: #0B1023; font-weight: 600;">2</th>
                                    <th style="color: #0B1023; font-weight: 600;">4</th>
                                    <th style="color: #0B1023; font-weight: 600;">6</th>
                                    <th style="color: #0B1023; font-weight: 600;">8</th>
                                    <th style="color: #0B1023; font-weight: 600;">10</th>
                                    <th style="color: #0B1023; font-weight: 600;">12</th>
                                    <th style="color: #0B1023; font-weight: 600;">14</th>
                                    <th style="color: #0B1023; font-weight: 600;">16</th>
                                    <th style="color: #0B1023; font-weight: 600;">18</th>
                                    <th style="color: #0B1023; font-weight: 600;">Observaciones</th>

                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><input type="text" id="color" name="color" class="form-control" placeholder="Ej: Rojo, Azul, Verde"></td>
                                    <td><input type="text" id="rib" name="rib" class="form-control" placeholder="RIB"></td>
                                    <td><input type="text" id="type_fabric" name="type_fabric" class="form-control" placeholder="Ej: Algod√≥n, Poli√©ster"></td>
                                    <td><input type="number" id="sz6_12" name="sz6_12" class="form-control" min="0" value="0" style="text-align: center;"></td>
                                    <td><input type="number" id="sz12_18" name="sz12_18" class="form-control" min="0" value="0" style="text-align: center;"></td>
                                    <td><input type="number" id="sz18_24" name="sz18_24" class="form-control" min="0" value="0" style="text-align: center;"></td>
                                    <td><input type="number" id="sz24_36" name="sz24_36" class="form-control" min="0" value="0" style="text-align: center;"></td>
                                    <td><input type="number" id="sz36_48" name="sz36_48" class="form-control" min="0" value="0" style="text-align: center;"></td>
                                    <td><input type="number" id="sz2" name="sz2" class="form-control" min="0" value="0" style="text-align: center;"></td>
                                    <td><input type="number" id="sz4" name="sz4" class="form-control" min="0" value="0" style="text-align: center;"></td>
                                    <td><input type="number" id="sz6" name="sz6" class="form-control" min="0" value="0" style="text-align: center;"></td>
                                    <td><input type="number" id="sz8" name="sz8" class="form-control" min="0" value="0" style="text-align: center;"></td>
                                    <td><input type="number" id="sz10" name="sz10" class="form-control" min="0" value="0" style="text-align: center;"></td>
                                    <td><input type="number" id="sz12" name="sz12" class="form-control" min="0" value="0" style="text-align: center;"></td>
                                    <td><input type="number" id="sz14" name="sz14" class="form-control" min="0" value="0" style="text-align: center;"></td>
                                    <td><input type="number" id="sz16" name="sz16" class="form-control" min="0" value="0" style="text-align: center;"></td>
                                    <td><input type="number" id="sz18" name="sz18" class="form-control" min="0" value="0" style="text-align: center;"></td>
                                    <td><textarea id="annotation" name="annotation" class="form-control" placeholder="Notas adicionales" rows="4" style="resize: vertical;"></textarea></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Botones -->
                <div style="margin-top: 2rem; display: flex; gap: 1rem; flex-wrap: wrap;">
                    <button type="reset" class="btn btn-secondary" style="flex: 1; min-width: 200px;">üîÑ Limpiar Formulario</button>
                    <button type="submit" class="btn btn-primary" style="flex: 1; min-width: 200px;">üíæ Guardar Entrega</button>
                </div>
            </form>

            <!-- Mensaje de estado -->
            <div id="statusMessage" style="margin-top: 1rem; display: none;">
                <div id="alertBox" class="alert" role="alert"></div>
            </div>
        </div>
    </div>
</div>

<script>
// Variable global para almacenar los talleres
let factories = [];

// Cargar talleres desde la API
async function loadFactories() {
    try {
        const response = await fetch('/api/factories');
        if (response.ok) {
            factories = await response.json();
        } else {
            console.error('Error al cargar talleres:', response.statusText);
        }
    } catch (error) {
        console.error('Error al conectar con la API:', error);
    }
}

// Mostrar dropdown con talleres
function showFactoriesDropdown(searchTerm = '') {
    const dropdown = document.getElementById('factoriesDropdown');
    const filtered = factories.filter(f => 
        f.owner.toLowerCase().includes(searchTerm.toLowerCase())
    );
    
    if (filtered.length === 0) {
        dropdown.innerHTML = '<div style="padding: 15px; text-align: center; color: #999;">No se encontraron talleres</div>';
    } else {
        dropdown.innerHTML = filtered.map(factory => `
            <div class="factory-option" data-factory-id="${factory.id_factory}" data-factory-name="${factory.owner}" 
                 style="padding: 12px 15px; border-bottom: 1px solid #f0f0f0; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 10px;">
                <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #0B1023 0%, #000000 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #0B1023; font-weight: bold; flex-shrink: 0;">
                    ${factory.owner.charAt(0).toUpperCase()}
                </div>
                <div style="flex: 1;">
                    <div style="font-weight: 600; color: #333;">${factory.owner}</div>
                    <div style="font-size: 0.85rem; color: #999;">ID: ${factory.id_factory}</div>
                </div>
                <div style="color: #0B1023; font-size: 1.2rem;">‚úì</div>
            </div>
        `).join('');
    }
    
    dropdown.style.display = 'block';
    
    // Agregar listeners a las opciones
    document.querySelectorAll('.factory-option').forEach(option => {
        option.addEventListener('click', function() {
            const factoryName = this.dataset.factoryName;
            const factoryId = this.dataset.factoryId;
            
            document.getElementById('factorySelect').value = factoryName;
            document.getElementById('owner').value = factoryName;
            dropdown.style.display = 'none';
            document.getElementById('ownerHelper').style.display = 'none';
            document.getElementById('factorySelect').classList.remove('is-invalid');
        });
        
        option.addEventListener('mouseover', function() {
            this.style.backgroundColor = '#f8f9ff';
        });
        
        option.addEventListener('mouseout', function() {
            this.style.backgroundColor = 'transparent';
        });
    });
}

// Event listeners para el campo de b√∫squeda
document.getElementById('factorySelect').addEventListener('input', function(e) {
    const searchTerm = this.value;
    if (searchTerm.length > 0) {
        showFactoriesDropdown(searchTerm);
    } else {
        document.getElementById('factoriesDropdown').style.display = 'none';
    }
});

document.getElementById('factorySelect').addEventListener('focus', function() {
    if (this.value.length > 0 || factories.length > 0) {
        showFactoriesDropdown(this.value);
    }
});

// Cerrar dropdown al hacer click fuera
document.addEventListener('click', function(e) {
    const dropdown = document.getElementById('factoriesDropdown');
    const factorySelect = document.getElementById('factorySelect');
    
    if (!e.target.closest('.form-group')) {
        dropdown.style.display = 'none';
    }
});

document.getElementById('deliveryForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    // Validar que el owner sea un taller v√°lido
    const ownerValue = document.getElementById('owner').value;
    const isValidFactory = factories.some(f => f.owner === ownerValue);
    
    if (!isValidFactory) {
        const alertBox = document.getElementById('alertBox');
        alertBox.className = 'alert alert-danger';
        alertBox.innerHTML = '<strong>‚ùå Error!</strong> Por favor selecciona un taller v√°lido de la lista';
        document.getElementById('statusMessage').style.display = 'block';
        document.getElementById('factorySelect').classList.add('is-invalid');
        document.getElementById('ownerHelper').style.display = 'block';
        return;
    }

    // Obtener datos del formulario
    const formData = {
        owner: ownerValue,
        date: document.getElementById('date').value,
        lot: document.getElementById('lot').value || null,
        type: document.getElementById('type').value || null,
        color: document.getElementById('color').value || null,
        annotation: document.getElementById('annotation').value || null,
        sz6_12: parseInt(document.getElementById('sz6_12').value) || 0,
        sz12_18: parseInt(document.getElementById('sz12_18').value) || 0,
        sz18_24: parseInt(document.getElementById('sz18_24').value) || 0,
        sz24_36: parseInt(document.getElementById('sz24_36').value) || 0,
        sz36_48: parseInt(document.getElementById('sz36_48').value) || 0,
        sz2: parseInt(document.getElementById('sz2').value) || 0,
        sz4: parseInt(document.getElementById('sz4').value) || 0,
        sz6: parseInt(document.getElementById('sz6').value) || 0,
        sz8: parseInt(document.getElementById('sz8').value) || 0,
        sz10: parseInt(document.getElementById('sz10').value) || 0,
        sz12: parseInt(document.getElementById('sz12').value) || 0,
        sz14: parseInt(document.getElementById('sz14').value) || 0,
        sz16: parseInt(document.getElementById('sz16').value) || 0,
        sz18: parseInt(document.getElementById('sz18').value) || 0
    };

    try {
        const response = await fetch('/api/deliveries', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        });

        const statusMessage = document.getElementById('statusMessage');
        const alertBox = document.getElementById('alertBox');

        if (response.ok) {
            const result = await response.json();
            alertBox.className = 'alert alert-success';
            alertBox.innerHTML = `<strong>‚úÖ √âxito!</strong> Entrega registrada correctamente. ID: ${result.id_delivery}`;
            document.getElementById('deliveryForm').reset();
            document.getElementById('owner').value = '';
            document.getElementById('factorySelect').value = '';
            
            // Establecer la fecha de hoy por defecto
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date').value = today;
        } else {
            const error = await response.json();
            alertBox.className = 'alert alert-danger';
            alertBox.innerHTML = `<strong>‚ùå Error!</strong> ${error.detail || 'Error al registrar la entrega'}`;
        }
        
        statusMessage.style.display = 'block';
    } catch (error) {
        const statusMessage = document.getElementById('statusMessage');
        const alertBox = document.getElementById('alertBox');
        alertBox.className = 'alert alert-danger';
        alertBox.innerHTML = `<strong>‚ùå Error!</strong> ${error.message}`;
        statusMessage.style.display = 'block';
    }
});

// Establecer la fecha de hoy por defecto y cargar talleres al cargar
document.addEventListener('DOMContentLoaded', function() {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('date').value = today;
    loadFactories();
});
</script>
{% endblock %}