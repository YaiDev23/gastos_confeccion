{% extends "base.html" %}

{% block title %}Resumen de Asistencia - Sistema de Asistencia{% endblock %}

{% block content %}
<a href="/menu" class="btn back-btn">
    <i style="margin-right: 8px;">‚Üê</i> Volver al men√∫
</a>

<h1>üìä Resumen de Asistencia del D√≠a</h1>
<p class="subtitle">
    Visualiza el registro de asistencias del d√≠a actual
</p>

<div style="max-width: 900px; margin: 0 auto;">
    <div style="background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 30px;">
        <p style="color: #666; margin-bottom: 20px;">
            <strong>Fecha y hora:</strong> {{ fecha_hora_bogota }}
        </p>
        
        <div id="resumen-stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px; text-align: center;">
                <h3 id="total-asistencias" style="font-size: 32px; margin: 0;">0</h3>
                <p style="margin: 10px 0 0 0; opacity: 0.9;">Total de Asistencias</p>
            </div>
            <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 20px; border-radius: 8px; text-align: center;">
                <h3 id="presentes" style="font-size: 32px; margin: 0;">0</h3>
                <p style="margin: 10px 0 0 0; opacity: 0.9;">Actualmente trabajando</p>
            </div>
            <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 20px; border-radius: 8px; text-align: center;">
                <h3 id="salidas-registradas" style="font-size: 32px; margin: 0;">0</h3>
                <p style="margin: 10px 0 0 0; opacity: 0.9;">Salidas Registradas</p>
            </div>
        </div>

        <div style="margin-bottom: 20px;">
            <button onclick="actualizarResumen()" class="btn" style="padding: 10px 20px;">
                <i style="margin-right: 8px;">üîÑ</i> Actualizar
            </button>
            <button onclick="descargarReporte()" class="btn" style="padding: 10px 20px; background-color: #28a745;">
                <i style="margin-right: 8px;">üì•</i> Descargar Reporte
            </button>
        </div>

        <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse;">
                <thead style="background-color: #667eea; color: white;">
                    <tr>
                        <th style="padding: 12px; border: 1px solid #ddd; text-align: left;">Trabajador</th>
                        <th style="padding: 12px; border: 1px solid #ddd; text-align: center;">Hora de Llegada</th>
                        <th style="padding: 12px; border: 1px solid #ddd; text-align: center;">Hora de Salida</th>
                        <th style="padding: 12px; border: 1px solid #ddd; text-align: center;">Horas Trabajadas</th>
                        <th style="padding: 12px; border: 1px solid #ddd; text-align: center;">Estado</th>
                    </tr>
                </thead>
                <tbody id="tabla-asistencias">
                    <tr>
                        <td colspan="5" style="padding: 20px; text-align: center; color: #666;">Cargando asistencias...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        actualizarResumen();
        // Actualizar cada 30 segundos
        setInterval(actualizarResumen, 30000);
    });

    async function actualizarResumen() {
        try {
            const response = await fetch('/assistence/api/asistencias-hoy');
            const data = await response.json();
            
            if (data.success) {
                const asistencias = data.data;
                
                // Calcular estad√≠sticas
                const totalAsistencias = asistencias.length;
                const presentes = asistencias.filter(a => a.departure_time === null).length;
                const salidasRegistradas = asistencias.filter(a => a.departure_time !== null).length;
                
                // Actualizar cards
                document.getElementById('total-asistencias').textContent = totalAsistencias;
                document.getElementById('presentes').textContent = presentes;
                document.getElementById('salidas-registradas').textContent = salidasRegistradas;
                
                // Actualizar tabla
                let html = '';
                asistencias.forEach((asistencia, index) => {
                    const arrival = new Date(asistencia.arrival_time);
                    const arrivalTime = arrival.toLocaleTimeString('es-CO', { hour: '2-digit', minute: '2-digit' });
                    
                    let departureTime = '--';
                    let horasTrabajadas = '--';
                    
                    if (asistencia.departure_time) {
                        const departure = new Date(asistencia.departure_time);
                        departureTime = departure.toLocaleTimeString('es-CO', { hour: '2-digit', minute: '2-digit' });
                        horasTrabajadas = ((departure - arrival) / (1000 * 60 * 60)).toFixed(2) + 'h';
                    } else {
                        const ahora = new Date();
                        horasTrabajadas = ((ahora - arrival) / (1000 * 60 * 60)).toFixed(2) + 'h';
                    }
                    
                    const estado = asistencia.estado;
                    const estadoColor = estado === 'Salida registrada' ? '#28a745' : '#ffc107';
                    
                    html += '<tr style="background-color: ' + (index % 2 === 0 ? '#f9f9f9' : 'white') + ';">';
                    html += '<td style="padding: 12px; border: 1px solid #ddd;">' + asistencia.worker + '</td>';
                    html += '<td style="padding: 12px; border: 1px solid #ddd; text-align: center;">' + arrivalTime + '</td>';
                    html += '<td style="padding: 12px; border: 1px solid #ddd; text-align: center;">' + departureTime + '</td>';
                    html += '<td style="padding: 12px; border: 1px solid #ddd; text-align: center;"><strong>' + horasTrabajadas + '</strong></td>';
                    html += '<td style="padding: 12px; border: 1px solid #ddd; text-align: center;"><span style="background-color: ' + estadoColor + '; color: white; padding: 5px 10px; border-radius: 3px; font-size: 12px; font-weight: bold;">' + estado + '</span></td>';
                    html += '</tr>';
                });
                
                if (html === '') {
                    html = '<tr><td colspan="5" style="padding: 20px; text-align: center; color: #666;">No hay asistencias registradas hoy</td></tr>';
                }
                
                document.getElementById('tabla-asistencias').innerHTML = html;
            }
        } catch (error) {
            console.error('Error al actualizar resumen:', error);
            document.getElementById('tabla-asistencias').innerHTML = '<tr><td colspan="5" style="padding: 20px; text-align: center; color: #d32f2f;">Error al cargar las asistencias</td></tr>';
        }
    }

    function descargarReporte() {
        // Crear CSV
        let csv = 'Trabajador,Hora de Llegada,Hora de Salida,Horas Trabajadas,Estado\n';
        
        const filas = document.querySelectorAll('#tabla-asistencias tr');
        filas.forEach(fila => {
            const celdas = fila.querySelectorAll('td');
            if (celdas.length > 0) {
                const trabajador = celdas[0].textContent;
                const llegada = celdas[1].textContent;
                const salida = celdas[2].textContent;
                const horas = celdas[3].textContent;
                const estado = celdas[4].textContent.trim();
                
                csv += `"${trabajador}","${llegada}","${salida}","${horas}","${estado}"\n`;
            }
        });
        
        // Descargar CSV
        const elemento = document.createElement('a');
        elemento.setAttribute('href', 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv));
        elemento.setAttribute('download', 'resumen_asistencia_' + new Date().toISOString().split('T')[0] + '.csv');
        elemento.style.display = 'none';
        document.body.appendChild(elemento);
        elemento.click();
        document.body.removeChild(elemento);
    }
</script>
{% endblock %}
