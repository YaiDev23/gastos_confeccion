{% extends "base.html" %}

{% block title %}Editar Usuario - Sistema de Gestión{% endblock %}

{% block content %}
<style>
    .form-container {
        max-width: 600px;
        margin: 0 auto;
    }

    .header-form {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 30px;
    }

    .header-form h1 {
        margin: 0;
        flex: 1;
    }

    .btn-volver {
        background-color: #95a5a6;
        color: white;
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        text-decoration: none;
        transition: all 0.3s ease;
    }

    .btn-volver:hover {
        background-color: #7f8c8d;
    }

    .form-group {
        margin-bottom: 25px;
    }

    label {
        display: block;
        margin-bottom: 10px;
        font-weight: 600;
        color: #0B1023;
        font-size: 15px;
    }

    input[type="text"],
    input[type="email"],
    input[type="password"],
    select {
        width: 100%;
        padding: 12px;
        border: 2px solid #ecf0f1;
        border-radius: 8px;
        font-size: 15px;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        transition: all 0.3s ease;
    }

    input[type="text"]:focus,
    input[type="email"]:focus,
    input[type="password"]:focus,
    select:focus {
        border-color: #0B1023;
        outline: none;
        background-color: #f8f9fa;
        box-shadow: 0 0 0 3px rgba(11, 16, 35, 0.1);
    }

    input:disabled,
    select:disabled {
        background-color: #ecf0f1;
        cursor: not-allowed;
    }

    .password-group {
        position: relative;
    }

    .toggle-password {
        position: absolute;
        right: 12px;
        top: 42px;
        cursor: pointer;
        color: #0B1023;
        background: none;
        border: none;
        font-size: 14px;
    }

    .help-text {
        font-size: 13px;
        color: #7f8c8d;
        margin-top: 5px;
    }

    .info-usuario {
        background: #e8f4f8;
        border-left: 4px solid #3498db;
        padding: 15px;
        border-radius: 6px;
        margin-bottom: 25px;
    }

    .info-usuario p {
        margin: 8px 0;
        color: #2c3e50;
        font-size: 14px;
    }

    .info-usuario strong {
        color: #0B1023;
    }

    .checkbox-group {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .checkbox-group input[type="checkbox"] {
        width: auto;
        cursor: pointer;
    }

    .formulario-buttons {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-top: 30px;
    }

    .btn {
        padding: 14px 30px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        font-weight: 600;
        transition: all 0.3s ease;
    }

    .btn-submit {
        background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        color: white;
    }

    .btn-submit:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(52, 152, 219, 0.3);
    }

    .btn-submit:disabled {
        background: #bdc3c7;
        cursor: not-allowed;
        transform: none;
    }

    .btn-cancelar {
        background-color: #95a5a6;
        color: white;
    }

    .btn-cancelar:hover {
        background-color: #7f8c8d;
    }

    .section-separador {
        margin-top: 30px;
        padding-top: 25px;
        border-top: 2px solid #ecf0f1;
    }

    .mensaje {
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .mensaje-exito {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    .mensaje-error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

    @media (max-width: 768px) {
        .formulario-buttons {
            grid-template-columns: 1fr;
        }

        .header-form {
            flex-direction: column;
            align-items: flex-start;
        }

        .btn-volver {
            width: 100%;
            justify-content: center;
        }
    }
</style>

<div class="form-container">
    <div class="header-form">
        <a href="/admin/usuarios" class="btn-volver">
            <i class="fas fa-arrow-left"></i>
            Volver
        </a>
        <h1>
            <i class="fas fa-user-edit"></i>
            Editar Usuario
        </h1>
    </div>

    <div id="mensaje"></div>

    <div class="info-usuario" id="infoUsuario">
        <p><i class="fas fa-spinner fa-spin"></i> Cargando información...</p>
    </div>

    <form id="formularioUsuario" onsubmit="guardarCambios(event)">
        <div class="form-group">
            <label for="username">
                <i class="fas fa-user"></i>
                Nombre de Usuario
            </label>
            <input 
                type="text" 
                id="username" 
                name="username" 
                disabled
                placeholder="ej: usuario123"
            >
            <div class="help-text">El nombre de usuario no puede ser modificado</div>
        </div>

        <div class="form-group">
            <label for="email">
                <i class="fas fa-envelope"></i>
                Email
            </label>
            <input 
                type="email" 
                id="email" 
                name="email" 
                placeholder="ej: usuario@ejemplo.com"
            >
        </div>

        <div class="form-group">
            <label for="rol">
                <i class="fas fa-tag"></i>
                Rol
            </label>
            <select id="rol" name="rol" required>
                <option value="admin">Administrador</option>
                <option value="taller">Taller</option>
                <option value="usuario">Usuario</option>
            </select>
        </div>

        <div class="form-group checkbox-group">
            <input 
                type="checkbox" 
                id="estado" 
                name="estado"
            >
            <label for="estado" style="margin-bottom: 0;">
                <i class="fas fa-toggle-on"></i>
                Usuario Activo
            </label>
        </div>

        <div class="section-separador">
            <h3 style="margin-top: 0; color: #0B1023;">Cambiar Contraseña</h3>
            <p class="help-text">Dejar en blanco para mantener la contraseña actual</p>

            <div class="form-group">
                <label for="newPassword">
                    <i class="fas fa-lock"></i>
                    Nueva Contraseña
                </label>
                <div class="password-group">
                    <input 
                        type="password" 
                        id="newPassword" 
                        name="newPassword" 
                        placeholder="Ingrese una nueva contraseña"
                        minlength="8"
                        onchange="validarNuevaContraseña()"
                    >
                    <button type="button" class="toggle-password" onclick="togglePassword()">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
            </div>
        </div>

        <div class="formulario-buttons">
            <button type="button" class="btn btn-cancelar" onclick="cancelar()">
                <i class="fas fa-times"></i>
                Cancelar
            </button>
            <button type="submit" class="btn btn-submit" id="btnSubmit">
                <i class="fas fa-save"></i>
                Guardar Cambios
            </button>
        </div>
    </form>
</div>

<script>
    let usuarioId = null;
    let usuarioOriginal = null;

    async function cargarUsuario() {
        try {
            const pathSegments = window.location.pathname.split('/');
            usuarioId = pathSegments[pathSegments.length - 1];

            const response = await fetch(`/users/${usuarioId}`);
            if (!response.ok) throw new Error('Usuario no encontrado');

            const usuario = await response.json();
            usuarioOriginal = { ...usuario };

            document.getElementById('username').value = usuario.username;
            document.getElementById('email').value = usuario.email || '';
            document.getElementById('rol').value = usuario.rol;
            document.getElementById('estado').checked = usuario.estado === 1;

            document.getElementById('infoUsuario').innerHTML = `
                <p><strong>ID:</strong> ${usuario.id_user}</p>
                <p><strong>Usuario:</strong> ${usuario.username}</p>
                <p><strong>Rol Actual:</strong> ${usuario.rol}</p>
                <p><strong>Estado:</strong> <span style="color: ${usuario.estado ? '#27ae60' : '#e74c3c'};">
                    ${usuario.estado ? '✓ Activo' : '✗ Inactivo'}
                </span></p>
            `;
        } catch (error) {
            console.error('Error:', error);
            mostrarMensaje('Error al cargar el usuario', 'error');
            setTimeout(() => {
                window.location.href = '/admin/usuarios';
            }, 2000);
        }
    }

    function togglePassword() {
        const input = document.getElementById('newPassword');
        const btn = document.querySelector('.toggle-password');
        
        if (input.type === 'password') {
            input.type = 'text';
            btn.innerHTML = '<i class="fas fa-eye-slash"></i>';
        } else {
            input.type = 'password';
            btn.innerHTML = '<i class="fas fa-eye"></i>';
        }
    }

    function validarNuevaContraseña() {
        const password = document.getElementById('newPassword').value;
        if (password && password.length < 8) {
            mostrarMensaje('La contraseña debe tener al menos 8 caracteres', 'error');
            document.getElementById('newPassword').value = '';
        }
    }

    async function guardarCambios(e) {
        e.preventDefault();

        const email = document.getElementById('email').value;
        const rol = document.getElementById('rol').value;
        const estado = document.getElementById('estado').checked ? 1 : 0;
        const newPassword = document.getElementById('newPassword').value;

        try {
            const updateData = {
                email,
                rol,
                estado
            };

            if (newPassword) {
                updateData.psw = newPassword;
            }

            const response = await fetch(`/users/${usuarioId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(updateData)
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.detail || 'Error al actualizar el usuario');
            }

            mostrarMensaje('Usuario actualizado correctamente', 'exito');
            setTimeout(() => {
                window.location.href = '/admin/usuarios';
            }, 1500);
        } catch (error) {
            console.error('Error:', error);
            mostrarMensaje(error.message || 'Error al actualizar el usuario', 'error');
        }
    }

    function mostrarMensaje(texto, tipo) {
        const mensajeDiv = document.getElementById('mensaje');
        mensajeDiv.innerHTML = `
            <div class="mensaje mensaje-${tipo}">
                <i class="fas fa-${tipo === 'exito' ? 'check-circle' : 'exclamation-circle'}"></i>
                ${texto}
            </div>
        `;
    }

    function cancelar() {
        window.location.href = '/admin/usuarios';
    }

    // Cargar usuario al iniciar
    window.addEventListener('load', cargarUsuario);
</script>

{% endblock %}
