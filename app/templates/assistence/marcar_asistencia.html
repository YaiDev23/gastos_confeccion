{% extends "base.html" %}

{% block title %}Marcar Llegada - Sistema de Asistencia{% endblock %}

{% block content %}
<a href="/menu" class="btn back-btn">
    <i style="margin-right: 8px;">‚Üê</i> Volver al men√∫
</a>

<h1>‚úÖ Marcar Llegada</h1>
<p class="subtitle">
    Selecciona el m√©todo para registrar la llegada
</p>

<!-- Pesta√±as de opciones -->
<div style="max-width: 600px; margin: 30px auto; display: flex; gap: 10px; border-bottom: 2px solid #ddd;">
    <button onclick="cambiarPestana('manual')" id="tab-manual" class="btn" style="flex: 1; background-color: #667eea; border: none; border-radius: 5px 5px 0 0; padding: 12px; font-weight: bold; color: white; cursor: pointer; font-size: 14px;">
        üë§ Selecci√≥n Manual
    </button>
    <button onclick="cambiarPestana('codigo')" id="tab-codigo" class="btn" style="flex: 1; background-color: #ccc; border: none; border-radius: 5px 5px 0 0; padding: 12px; font-weight: bold; color: #333; cursor: pointer; font-size: 14px;">
        üì± Escanear C√≥digo
    </button>
</div>

<div style="max-width: 600px; margin: 0 auto;">
    <div id="mensaje-exito" style="display: none; padding: 15px; margin-bottom: 20px; border-radius: 5px; background-color: #d4edda; border: 1px solid #c3e6cb; color: #155724;">
    </div>

    <div id="mensaje-error" style="display: none; padding: 15px; margin-bottom: 20px; border-radius: 5px; background-color: #f8d7da; border: 1px solid #f5c6cb; color: #721c24;">
    </div>

    <!-- OPCI√ìN 1: MANUAL -->
    <div id="contenedor-manual" style="display: block;">
        <div style="margin-bottom: 20px;">
            <label style="display: block; font-size: 18px; font-weight: bold; margin-bottom: 15px; color: #333;">
                <i style="color: #667eea; margin-right: 8px;">üë§</i> Selecciona un trabajador:
            </label>
            <div id="trabajadores-container" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; margin-bottom: 20px;">
                <p style="text-align: center; color: #666; grid-column: 1/-1;">Cargando trabajadores...</p>
            </div>
        </div>

        <input type="hidden" id="trabajador_seleccionado" value="">

        <button type="button" onclick="marcarLlegada()" class="btn" style="width: 100%; margin-top: 20px; padding: 15px; font-size: 16px; font-weight: bold; background-color: #667eea;">
            <i style="margin-right: 8px;">üïê</i> Registrar Llegada
        </button>
    </div>

    <!-- OPCI√ìN 2: ESCANEO DE C√ìDIGO -->
    <div id="contenedor-codigo" style="display: none;">
        <div style="margin-bottom: 20px;">
            <label style="display: block; font-size: 18px; font-weight: bold; margin-bottom: 15px; color: #333;">
                <i style="color: #e74c3c; margin-right: 8px;">üì±</i> Escanea el c√≥digo de barras:
            </label>
            <div style="background-color: #f9f9f9; padding: 20px; border-radius: 8px; border: 2px dashed #ccc;">
                <input type="text" 
                       id="input_reference_id" 
                       placeholder="Apunta el lector de c√≥digo de barras aqu√≠..." 
                       style="width: 100%; padding: 15px; font-size: 16px; border: 2px solid #ddd; border-radius: 5px; text-align: center;"
                       autocomplete="off"
                       autofocus>
                <p style="text-align: center; color: #999; margin-top: 10px; font-size: 12px;">
                    El c√≥digo se procesar√° autom√°ticamente cuando escanees
                </p>
            </div>
            <div id="worker-info" style="display: none; margin-top: 20px; padding: 15px; background-color: #e8f5e9; border: 2px solid #28a745; border-radius: 8px;">
                <p style="color: #28a745; font-weight: bold; margin: 0;">‚úì Trabajador detectado:</p>
                <p id="worker-name" style="color: #333; font-size: 18px; font-weight: bold; margin: 5px 0 0 0;"></p>
            </div>
        </div>
    </div>


<div style="max-width: 600px; margin: 40px auto;">
    <h2>üìä Asistencias Registradas Hoy</h2>
    <div id="asistencias-container" style="margin-top: 20px;">
        <p style="text-align: center; color: #666;">Cargando asistencias...</p>
    </div>
</div>

<script>
    // Variables globales
    let pestanaActual = 'manual';

    // Cargar trabajadores activos al abrir la p√°gina
    document.addEventListener('DOMContentLoaded', function() {
        cargarTrabajadores();
        cargarAsistencias();
        
        // Escuchar eventos en el input de c√≥digo de barras
        const inputReferenceId = document.getElementById('input_reference_id');
        inputReferenceId.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                marcarLlegadaPorCodigo();
            }
        });
        
        // Actualizar asistencias cada 10 segundos
        setInterval(cargarAsistencias, 10000);
    });

    function cambiarPestana(pestana) {
        pestanaActual = pestana;
        
        // Actualizar visibilidad de contenedores
        document.getElementById('contenedor-manual').style.display = pestana === 'manual' ? 'block' : 'none';
        document.getElementById('contenedor-codigo').style.display = pestana === 'codigo' ? 'block' : 'none';
        
        // Actualizar estilos de pesta√±as
        document.getElementById('tab-manual').style.backgroundColor = pestana === 'manual' ? '#667eea' : '#ccc';
        document.getElementById('tab-manual').style.color = pestana === 'manual' ? 'white' : '#333';
        
        document.getElementById('tab-codigo').style.backgroundColor = pestana === 'codigo' ? '#e74c3c' : '#ccc';
        document.getElementById('tab-codigo').style.color = pestana === 'codigo' ? 'white' : '#333';
        
        // Si cambia a c√≥digo, enfocar el input
        if (pestana === 'codigo') {
            setTimeout(() => {
                document.getElementById('input_reference_id').focus();
            }, 100);
        }
    }

    async function cargarTrabajadores() {
        try {
            const response = await fetch('/assistence/api/trabajadores');
            const data = await response.json();
            
            if (data.success) {
                const container = document.getElementById('trabajadores-container');
                container.innerHTML = '';
                
                if (data.data.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #666; grid-column: 1/-1;">No hay trabajadores disponibles</p>';
                    return;
                }
                
                data.data.forEach(trabajador => {
                    const card = document.createElement('div');
                    card.className = 'trabajador-card';
                    card.id = `card-${trabajador.id}`;
                    card.style.cssText = `
                        padding: 15px;
                        border: 2px solid #ddd;
                        border-radius: 8px;
                        cursor: pointer;
                        text-align: center;
                        transition: all 0.3s ease;
                        background-color: white;
                    `;
                    card.innerHTML = `
                        <div style="font-size: 24px; margin-bottom: 10px;">üë§</div>
                        <div style="font-weight: bold; font-size: 14px; color: #333; margin-bottom: 5px;">${trabajador.nombre} ${trabajador.apellido}</div>
                        <div style="font-size: 12px; color: #666; margin-bottom: 5px;">${trabajador.cargo}</div>
                        <div style="font-size: 11px; color: #999;">ID: ${trabajador.cedula}</div>
                    `;
                    
                    card.addEventListener('mouseenter', function() {
                        this.style.borderColor = '#667eea';
                        this.style.boxShadow = '0 4px 12px rgba(102, 126, 234, 0.2)';
                        this.style.backgroundColor = '#f0f4ff';
                    });
                    
                    card.addEventListener('mouseleave', function() {
                        const isSelected = document.getElementById('trabajador_seleccionado').value === trabajador.id.toString();
                        this.style.borderColor = isSelected ? '#667eea' : '#ddd';
                        this.style.boxShadow = isSelected ? '0 4px 12px rgba(102, 126, 234, 0.3)' : 'none';
                        this.style.backgroundColor = isSelected ? '#e8ecff' : 'white';
                    });
                    
                    card.addEventListener('click', function() {
                        // Deseleccionar tarjeta anterior
                        const previousSelected = document.querySelector('.trabajador-card-selected');
                        if (previousSelected) {
                            previousSelected.classList.remove('trabajador-card-selected');
                            previousSelected.style.borderColor = '#ddd';
                            previousSelected.style.backgroundColor = 'white';
                            previousSelected.style.boxShadow = 'none';
                        }
                        
                        // Seleccionar nueva tarjeta
                        document.getElementById('trabajador_seleccionado').value = trabajador.id;
                        this.classList.add('trabajador-card-selected');
                        this.style.borderColor = '#667eea';
                        this.style.backgroundColor = '#e8ecff';
                        this.style.boxShadow = '0 4px 12px rgba(102, 126, 234, 0.3)';
                        this.style.borderWidth = '3px';
                    });
                    
                    container.appendChild(card);
                });
            }
        } catch (error) {
            console.error('Error al cargar trabajadores:', error);
            const container = document.getElementById('trabajadores-container');
            container.innerHTML = '<p style="text-align: center; color: #e74c3c; grid-column: 1/-1;">Error al cargar trabajadores</p>';
        }
    }

    async function marcarLlegada() {
        const trabajadorId = document.getElementById('trabajador_seleccionado').value;
        
        if (!trabajadorId) {
            mostrarError('Por favor selecciona un trabajador');
            return;
        }

        try {
            const response = await fetch('/assistence/api/marcar-llegada', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    worker_id: parseInt(trabajadorId)
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                mostrarExito(data.message);
                document.getElementById('trabajador_seleccionado').value = '';
                cargarAsistencias();
                
                // Reproducir sonido de √©xito
                reproducirSonido();
            } else {
                mostrarError(data.error);
            }
        } catch (error) {
            console.error('Error al marcar llegada:', error);
            mostrarError('Error al registrar la llegada');
        }
    }

    async function marcarLlegadaPorCodigo() {
        const referenceId = document.getElementById('input_reference_id').value.trim();
        
        if (!referenceId) {
            mostrarError('Por favor escanea un c√≥digo de barras');
            return;
        }

        try {
            const response = await fetch('/assistence/api/marcar-llegada-codigo', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    reference_id: referenceId
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                mostrarExito(data.message);
                
                // Mostrar informaci√≥n del trabajador
                const workerInfo = document.getElementById('worker-info');
                document.getElementById('worker-name').textContent = data.data.worker;
                workerInfo.style.display = 'block';
                
                // Limpiar input y dar foco de nuevo
                document.getElementById('input_reference_id').value = '';
                document.getElementById('input_reference_id').focus();
                
                // Ocultar info despu√©s de 3 segundos
                setTimeout(() => {
                    workerInfo.style.display = 'none';
                }, 3000);
                
                cargarAsistencias();
                reproducirSonido();
            } else {
                mostrarError(data.error || 'No se encontr√≥ trabajador con ese c√≥digo');
                document.getElementById('input_reference_id').value = '';
                document.getElementById('input_reference_id').focus();
            }
        } catch (error) {
            console.error('Error al marcar llegada:', error);
            mostrarError('Error al procesar el c√≥digo de barras');
            document.getElementById('input_reference_id').value = '';
            document.getElementById('input_reference_id').focus();
        }
    }

    async function marcarSalida(asistenceId) {
        try {
            const response = await fetch('/assistence/api/marcar-salida', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    id_assistence: parseInt(asistenceId)
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                mostrarExito(data.message);
                cargarAsistencias();
                reproducirSonido();
            } else {
                mostrarError(data.error);
            }
        } catch (error) {
            console.error('Error al marcar salida:', error);
            mostrarError('Error al registrar la salida');
        }
    }

    async function cargarAsistencias() {
        try {
            const response = await fetch('/assistence/api/asistencias-hoy');
            const data = await response.json();
            
            const container = document.getElementById('asistencias-container');
            
            if (data.success && data.data.length > 0) {
                let html = '<div style="overflow-x: auto;">';
                html += '<table style="width: 100%; border-collapse: collapse;">';
                html += '<thead style="background-color: #667eea; color: white;">';
                html += '<tr>';
                html += '<th style="padding: 12px; border: 1px solid #ddd; text-align: left;">Trabajador</th>';
                html += '<th style="padding: 12px; border: 1px solid #ddd; text-align: center;">Llegada</th>';
                html += '<th style="padding: 12px; border: 1px solid #ddd; text-align: center;">Estado</th>';
                html += '<th style="padding: 12px; border: 1px solid #ddd; text-align: center;">Acci√≥n</th>';
                html += '</tr>';
                html += '</thead>';
                html += '<tbody>';
                
                data.data.forEach((asistencia, index) => {
                    const arrival = new Date(asistencia.arrival_time);
                    const arrivalTime = arrival.toLocaleTimeString('es-CO', { hour: '2-digit', minute: '2-digit' });
                    const estado = asistencia.estado;
                    const estadoColor = estado === 'Sali√≥' ? '#28a745' : '#ffc107';
                    const tienesSalida = asistencia.departure_time !== null;
                    
                    let botonAccion = '';
                    if (!tienesSalida) {
                        botonAccion = `<button onclick="marcarSalida(${asistencia.id_assistence})" style="padding: 6px 12px; background-color: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: bold;">‚úì Salida</button>`;
                    } else {
                        botonAccion = '<span style="color: #28a745; font-weight: bold;">‚úì Completado</span>';
                    }
                    
                    html += '<tr style="background-color: ' + (index % 2 === 0 ? '#f9f9f9' : 'white') + ';">';
                    html += '<td style="padding: 12px; border: 1px solid #ddd;">' + asistencia.worker + '</td>';
                    html += '<td style="padding: 12px; border: 1px solid #ddd; text-align: center;">' + arrivalTime + '</td>';
                    html += '<td style="padding: 12px; border: 1px solid #ddd; text-align: center;"><span style="background-color: ' + estadoColor + '; color: white; padding: 5px 10px; border-radius: 3px; font-size: 12px; font-weight: bold;">' + estado + '</span></td>';
                    html += '<td style="padding: 12px; border: 1px solid #ddd; text-align: center;">' + botonAccion + '</td>';
                    html += '</tr>';
                });
                
                html += '</tbody>';
                html += '</table>';
                html += '</div>';
                container.innerHTML = html;
            } else {
                container.innerHTML = '<p style="text-align: center; color: #666;">No hay asistencias registradas hoy</p>';
            }
        } catch (error) {
            console.error('Error al cargar asistencias:', error);
        }
    }

    function mostrarExito(mensaje) {
        const div = document.getElementById('mensaje-exito');
        div.textContent = mensaje;
        div.style.display = 'block';
        
        // Ocultar despu√©s de 5 segundos
        setTimeout(() => {
            div.style.display = 'none';
        }, 5000);
    }

    function mostrarError(mensaje) {
        const div = document.getElementById('mensaje-error');
        div.textContent = mensaje;
        div.style.display = 'block';
        
        // Ocultar despu√©s de 5 segundos
        setTimeout(() => {
            div.style.display = 'none';
        }, 5000);
    }

    function reproducirSonido() {
        // Usar Web Audio API para reproducir un tono simple
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.value = 800;
        oscillator.type = 'sine';
        
        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.5);
    }
</script>
{% endblock %}
